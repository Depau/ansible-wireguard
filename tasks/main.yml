---
- name: Install WireGuard netdev for systemd-networkd
  when: with_sysd_netd
  notify: Restart systemd-networkd
  template:
    src: systemd-networkd.netdev.j2
    dest: "/etc/systemd/network/{{ wg_iface_name }}.netdev"
    lstrip_blocks: yes
    owner: systemd-network
    group: systemd-network
    mode: 0600

- name: Install WireGuard network for systemd-networkd
  when: with_sysd_netd
  notify: Restart systemd-networkd
  template:
    src: systemd-networkd.network.j2
    dest: "/etc/systemd/network/{{ wg_iface_name }}.network"
    lstrip_blocks: yes
    owner: systemd-network
    group: systemd-network
    mode: 0600

- name: Install WireGuard configs for wg-quick
  when: with_wgquick
  notify: "Enable and restart wg-quick@{{ wg_iface_name }}.service"
  template:
    src: wg-quick.conf.j2
    dest: "/etc/wireguard/{{ wg_iface_name }}.conf"
    lstrip_blocks: yes
    owner: root
    group: root
    mode: 0600

- name: Allow WireGuard in firewall
  when: wg.get('endpoint_port', None) and with_ufw
  ufw:
    rule: allow
    proto: udp
    port: "{{ wg['endpoint_port'] }}"

- name: Enable/disable IPv4 forwarding
  sysctl:
    name: net.ipv4.ip_forward
    value: '{{ 1 if is_wg_router or is_gateway_ip4 else 0 }}'
    sysctl_set: yes
    state: present
    reload: yes

- name: Enable/disable IPv6 forwarding (default)
  sysctl:
    name: net.ipv6.conf.default.forwarding
    value: '{{ 1 if is_wg_router or is_gateway_ip4 else 0 }}'
    sysctl_set: yes
    state: present
    reload: yes

- name: Enable/disable IPv6 forwarding (all)
  sysctl:
    name: net.ipv6.conf.all.forwarding
    value: '{{ 1 if is_wg_router or is_gateway_ip4 else 0 }}'
    sysctl_set: yes
    state: present
    reload: yes

- name: Enable/disable wg<->wg forwarding
  when: with_ufw
  ufw:
    rule: '{{ "allow" if is_wg_router else "deny" }}'
    route: yes
    from: "{{ wg_iface_name }}"
    to: "{{ wg_iface_name }}"

- name: Enable/disable wg->internet forwarding
  when: with_ufw 
  ufw:
    rule: '{{ "allow" if is_gateway_ip4 or is_gateway_ip6 else "deny" }}'
    route: yes
    from: "{{ wg_iface_name }}"
    to: "{{ ansible_facts['default_ipv4']['interface'] }}"

- name: Enable/disable wg<-internet forwarding
  when: with_ufw 
  ufw:
    rule: '{{ "allow" if is_gateway_ip4 or is_gateway_ip6 else "deny" }}'
    route: yes
    from: "{{ ansible_facts['default_ipv4']['interface'] }}"
    to: "{{ wg_iface_name }}"

